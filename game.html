<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuturY - Sistema Solare</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
        }
    }
    </script>
    <!-- CSS Design System -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/panels.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <!-- 3D Canvas (behind everything) -->
    <canvas id="solar-system-canvas"></canvas>

    <!-- Launch Sequence Overlay -->
    <div id="launch-sequence-overlay">
        <div id="countdown-text" class="countdown-display"></div>
    </div>

    <!-- Notifications Container -->
    <div id="notifications-container"></div>

    <!-- App Container: Grid Layout -->
    <div id="app-container">

        <!-- === NAV BAR (top) === -->
        <nav class="nav-bar">
            <button class="hamburger-btn" id="hamburger-btn" aria-label="Toggle sidebar">&#9776;</button>

            <div class="nav-bar__brand">
                <span class="nav-bar__title">FuturY</span>
            </div>

            <div class="nav-bar__time">
                <span class="nav-bar__year" id="game-year">2100</span>
                <span class="nav-bar__date" id="game-date">(gen-01 0:00)</span>
            </div>

            <div class="nav-bar__tabs">
                <button class="nav-btn active" data-view="solar-system">
                    <span class="nav-btn__icon">üåå</span>
                    <span class="nav-btn__label">Solar System</span>
                </button>
                <button class="nav-btn" data-view="missions">
                    <span class="nav-btn__icon">üöÄ</span>
                    <span class="nav-btn__label">Missions</span>
                </button>
                <button class="nav-btn" data-view="buildings">
                    <span class="nav-btn__icon">üèóÔ∏è</span>
                    <span class="nav-btn__label">Buildings</span>
                </button>
                <button class="nav-btn" data-view="research">
                    <span class="nav-btn__icon">üî¨</span>
                    <span class="nav-btn__label">Research</span>
                </button>
                <button class="nav-btn" data-view="economy">
                    <span class="nav-btn__icon">üí∞</span>
                    <span class="nav-btn__label">Economy</span>
                </button>
            </div>
        </nav>

        <!-- === SIDEBAR LEFT === -->
        <aside class="sidebar-left" id="sidebar-left">
            <div class="sidebar-left__header">
                <h3>üìä Dashboard</h3>
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">‚óÄ</button>
            </div>
            <div class="sidebar-left__content">

                <!-- Resources Section -->
                <div class="sidebar-left__section resources-section">
                    <div class="sidebar-left__section-title">Resources</div>
                    <div id="resources-list">
                        <!-- Populated dynamically by JS -->
                    </div>
                </div>

                <!-- Buildings Section (visible when buildings view active) -->
                <div class="sidebar-left__section buildings-section" id="buildings-panel" style="display: none;">
                    <div class="sidebar-left__section-title">üèóÔ∏è Earth Management</div>

                    <!-- Tabs -->
                    <div class="buildings-tabs">
                        <button id="buildings-tab-build" class="buildings-tab active">üèóÔ∏è Build</button>
                        <button id="buildings-tab-list" class="buildings-tab">üìã Buildings</button>
                    </div>

                    <!-- Build Tab Content -->
                    <div id="buildings-build-content">
                        <p style="color: var(--color-text-faint); font-size: var(--font-size-base); margin-bottom: var(--space-md);">Available buildings for construction:</p>
                        <div id="buildings-available-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Buildings List Tab Content -->
                    <div id="buildings-list-content" style="display: none;">
                        <div style="margin-bottom: var(--space-xl);">
                            <h4 style="color: var(--color-accent); font-size: var(--font-size-md); margin: 0 0 var(--space-sm) 0;">üî® In Construction</h4>
                            <div id="buildings-in-construction">
                                <div style="color: var(--color-text-faint); font-size: var(--font-size-base);">No buildings in construction</div>
                            </div>
                        </div>
                        <div>
                            <h4 style="color: var(--color-accent); font-size: var(--font-size-md); margin: 0 0 var(--space-sm) 0;">‚úÖ Completed</h4>
                            <div id="buildings-completed">
                                <div style="color: var(--color-text-faint); font-size: var(--font-size-base);">No buildings completed</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Research Section (visible when research view active) -->
                <div class="sidebar-left__section research-section" id="research-panel" style="display: none;">
                    <div class="sidebar-left__section-title">üî¨ Research</div>
                    <div class="tech-category-filter" id="tech-category-filter">
                        <!-- Populated by ResearchPanel.js -->
                    </div>
                    <div class="tech-tree" id="tech-tree">
                        <!-- Populated by ResearchPanel.js -->
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile sidebar backdrop -->
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

        <!-- === MAIN VIEWPORT === -->
        <main class="main-viewport">
            <!-- HUD Overlay (controls hint) -->
            <div id="hud" class="hud-overlay">
                <div class="controls-hint">
                    Click + trascina: ruota<br>
                    Scroll: zoom<br>
                    Click destro + trascina: pan<br>
                    Click su pianeta: info
                </div>
            </div>
        </main>

        <!-- === BOTTOM DOCK === -->
        <div class="bottom-dock" id="bottom-dock">
            <div class="dock__resize-handle" id="dock-resize-handle"></div>
            <div class="dock__tabs">
                <button class="dock__tab active" data-dock-tab="missions">üöÄ Missions</button>
                <button class="dock__tab" data-dock-tab="economy">üí∞ Economy</button>
                <button class="dock__tab" data-dock-tab="log">üìã Log</button>
            </div>
            <div class="dock__content">
                <!-- Missions Tab -->
                <div class="dock__panel active" id="dock-missions" data-dock-panel="missions">
                    <div class="missions-section">
                        <div class="missions-section__header">
                            <h3>üöÄ Active Missions</h3>
                            <button id="toggle-trajectories-btn" class="active">üëÅÔ∏è Hide Trajectories</button>
                        </div>
                        <div id="missions-list"></div>
                    </div>
                </div>

                <!-- Economy Tab -->
                <div class="dock__panel" id="dock-economy" data-dock-panel="economy">
                    <div class="economy-section" id="economy-content">
                        <!-- Populated by EconomyPanel.js -->
                        <p style="color: var(--color-text-faint);">Economy panel loading...</p>
                    </div>
                </div>

                <!-- Log Tab -->
                <div class="dock__panel" id="dock-log" data-dock-panel="log">
                    <div class="log-section">
                        <div class="log-filters" id="log-filters">
                            <button class="log-filter-btn active" data-filter="all">All</button>
                            <button class="log-filter-btn" data-filter="success">Success</button>
                            <button class="log-filter-btn" data-filter="warning">Warning</button>
                            <button class="log-filter-btn" data-filter="error">Error</button>
                        </div>
                        <div id="log-entries">
                            <div class="log-entry">
                                <span class="log-entry__time">--:--</span>
                                <span class="log-entry__icon">üöÄ</span>
                                <span class="log-entry__message">Welcome to FuturY! Select a planet to begin.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Planet Information Panel (floating, outside grid) -->
    <div id="planet-info-panel" class="planet-panel hidden">
        <div class="panel-header">
            <h3 id="planet-name">Planet Name</h3>
            <button id="close-panel" class="close-btn">&times;</button>
        </div>
        <div class="panel-content">
            <p id="planet-description" class="description"></p>

            <div class="info-grid">
                <div class="info-item">
                    <span class="label">Type:</span>
                    <span id="planet-type" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Mass:</span>
                    <span id="planet-mass" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Diameter:</span>
                    <span id="planet-diameter" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Moons:</span>
                    <span id="planet-moons" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Distance from Sun:</span>
                    <span id="planet-distance-sun" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Distance from Earth:</span>
                    <span id="planet-distance-earth" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Orbital Period:</span>
                    <span id="planet-orbital-period" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Travel Time:</span>
                    <span id="planet-travel-time" class="value"></span>
                </div>
                <div class="info-item">
                    <span class="label">Mission Cost:</span>
                    <span id="planet-mission-cost" class="value"></span>
                </div>
            </div>
            <button id="launch-mission-btn" class="launch-btn">üöÄ Launch Mission</button>
        </div>
    </div>

    <script type="module">
        import { SolarSystemRenderer } from './js/graphics/SolarSystemRenderer.js?v=20250217';
        import { MissionTrajectoryRenderer } from './js/graphics/MissionTrajectoryRenderer.js?v=20250217';
        import { UIController } from './js/ui/UIController.js?v=20250217';
        import { ResourceManager } from './js/core/ResourceManager.js?v=20250217';
        import { MissionManager } from './js/core/MissionManager.js?v=20250217';
        import { BuildingManager } from './js/core/BuildingManager.js?v=20250217';
        import { SaveManager } from './js/core/SaveManager.js?v=20250217';
        import { TimeManager } from './js/core/TimeManager.js?v=20250217';
        import { NotificationManager } from './js/ui/NotificationManager.js?v=20250217';
        import { TutorialManager } from './js/ui/TutorialManager.js?v=20250217';
        import { ColonizationManager } from './js/core/ColonizationManager.js?v=20250217';
        import { ResearchPanel } from './js/ui/ResearchPanel.js?v=20250217';
        import { EconomyPanel } from './js/ui/EconomyPanel.js?v=20250217';

        const renderer = new SolarSystemRenderer('solar-system-canvas');
        const uiController = new UIController();
        const resourceManager = new ResourceManager({ code: 'USA' });
        const missionManager = new MissionManager();
        const timeManager = new TimeManager();
        const buildingManager = new BuildingManager(resourceManager, timeManager);
        const saveManager = new SaveManager();
        const researchPanel = new ResearchPanel('tech-tree', 'tech-category-filter');
        const economyPanel = new EconomyPanel('economy-content');
        const notificationManager = new NotificationManager();
        const tutorialManager = new TutorialManager();
        const colonizationManager = new ColonizationManager();

        // Expose managers globally for SaveManager access
        window.timeManager = timeManager;
        window.resourceManager = resourceManager;
        window.missionManager = missionManager;

        let selectedPlanet = null;
        let trajectoryRenderer = null;

        // === LAYOUT: Sidebar Toggle (card_706) ===
        const sidebarEl = document.getElementById('sidebar-left');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle');
        const appContainer = document.getElementById('app-container');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');

        // Load sidebar state from localStorage
        const sidebarCollapsed = localStorage.getItem('futury-sidebar-collapsed') === 'true';
        if (sidebarCollapsed) {
            appContainer.classList.add('sidebar-collapsed');
        }

        sidebarToggleBtn.addEventListener('click', () => {
            appContainer.classList.toggle('sidebar-collapsed');
            localStorage.setItem('futury-sidebar-collapsed', appContainer.classList.contains('sidebar-collapsed'));
        });

        // Mobile hamburger
        hamburgerBtn.addEventListener('click', () => {
            sidebarEl.classList.toggle('open');
        });

        sidebarBackdrop.addEventListener('click', () => {
            sidebarEl.classList.remove('open');
        });

        // === LAYOUT: Bottom Dock Tabs (card_707) ===
        const dockTabs = document.querySelectorAll('.dock__tab');
        const dockPanels = document.querySelectorAll('.dock__panel');
        const bottomDock = document.getElementById('bottom-dock');

        dockTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.dockTab;

                // Double-click to minimize/expand
                if (tab.classList.contains('active')) {
                    bottomDock.classList.toggle('minimized');
                    return;
                }

                // Switch tab
                dockTabs.forEach(t => t.classList.remove('active'));
                dockPanels.forEach(p => p.classList.remove('active'));
                tab.classList.add('active');

                const panel = document.querySelector(`[data-dock-panel="${targetTab}"]`);
                if (panel) panel.classList.add('active');

                // Expand if minimized
                bottomDock.classList.remove('minimized');
            });
        });

        // Dock resize handle
        const dockResizeHandle = document.getElementById('dock-resize-handle');
        let dockResizing = false;

        dockResizeHandle.addEventListener('mousedown', (e) => {
            dockResizing = true;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!dockResizing) return;
            const newHeight = window.innerHeight - e.clientY;
            const clampedHeight = Math.max(48, Math.min(newHeight, window.innerHeight * 0.5));
            bottomDock.style.height = clampedHeight + 'px';
        });

        document.addEventListener('mouseup', () => {
            dockResizing = false;
        });

        // === LAYOUT: Nav-bar tabs (card_708) ===
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const view = btn.dataset.view;
                const buildingsPanel = document.getElementById('buildings-panel');
                const researchPanel = document.getElementById('research-panel');

                // Show/hide sidebar sections based on view
                buildingsPanel.style.display = (view === 'buildings') ? 'block' : 'none';
                researchPanel.style.display = (view === 'research') ? 'block' : 'none';

                if (view === 'buildings') {
                    updateBuildingsPanel();
                }

                // Focus dock tabs based on view
                if (view === 'missions' || view === 'economy') {
                    const dockTab = document.querySelector(`.dock__tab[data-dock-tab="${view === 'missions' ? 'missions' : 'economy'}"]`);
                    if (dockTab) dockTab.click();
                }

                notificationManager.info('Navigation', `Switched to ${view}`, 2000);
                tutorialManager.onEvent('nav-click', view);
            });
        });

        // === LOG: Add log entries from notifications (card_713) ===
        const logEntries = document.getElementById('log-entries');
        const originalNotify = notificationManager.notify?.bind(notificationManager);

        function addLogEntry(type, title, message) {
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            const icons = { success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå', info: 'üí¨' };
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `
                <span class="log-entry__time">${time}</span>
                <span class="log-entry__icon">${icons[type] || 'üí¨'}</span>
                <span class="log-entry__message">${title}: ${message}</span>
            `;
            logEntries.prepend(entry);

            // Keep max 100 entries
            while (logEntries.children.length > 100) {
                logEntries.removeChild(logEntries.lastChild);
            }
        }

        // Hook into NotificationManager
        const origSuccess = notificationManager.success?.bind(notificationManager);
        const origWarning = notificationManager.warning?.bind(notificationManager);
        const origError = notificationManager.error?.bind(notificationManager);
        const origInfo = notificationManager.info?.bind(notificationManager);

        if (origSuccess) {
            notificationManager.success = (title, msg, dur) => {
                addLogEntry('success', title, msg);
                return origSuccess(title, msg, dur);
            };
        }
        if (origWarning) {
            notificationManager.warning = (title, msg, dur) => {
                addLogEntry('warning', title, msg);
                return origWarning(title, msg, dur);
            };
        }
        if (origError) {
            notificationManager.error = (title, msg, dur) => {
                addLogEntry('error', title, msg);
                return origError(title, msg, dur);
            };
        }
        if (origInfo) {
            notificationManager.info = (title, msg, dur) => {
                addLogEntry('info', title, msg);
                return origInfo(title, msg, dur);
            };
        }

        // Log filter buttons
        document.querySelectorAll('.log-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const filter = btn.dataset.filter;
                document.querySelectorAll('.log-entry').forEach(entry => {
                    if (filter === 'all' || entry.classList.contains(filter)) {
                        entry.style.display = '';
                    } else {
                        entry.style.display = 'none';
                    }
                });
            });
        });

        // Connect renderer to UI controller for planet selection
        renderer.onPlanetClick = (planetInfo) => {
            if (planetInfo) {
                selectedPlanet = planetInfo;
                uiController.showPlanetInfo(planetInfo);
                updateMissionCostDisplay(planetInfo);
                updateColonizationStatus(planetInfo);
                tutorialManager.onEvent('planet-click', planetInfo.name);
            } else {
                selectedPlanet = null;
                uiController.hidePlanetInfo();
            }
        };

        // Update mission cost display
        function updateMissionCostDisplay(planetInfo) {
            const costs = missionManager.getMissionCost(planetInfo.name);
            const costEl = document.getElementById('planet-mission-cost');
            if (costEl && costs) {
                costEl.innerHTML = `
                    üí∞ ${(costs.budget / 1000).toFixed(0)}K
                    üî¨ ${costs.science}
                    ‚ö° ${costs.energy}
                    ‚öôÔ∏è ${costs.materials}
                `;
            }
        }

        // Update colonization status display (card_405)
        function updateColonizationStatus(planetInfo) {
            const planetName = planetInfo.name;
            const status = colonizationManager.getColonizationStatus(planetName);

            const panelContent = document.querySelector('#planet-info-panel .panel-content');
            let statusEl = document.getElementById('colonization-status-display');

            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'colonization-status-display';
                panelContent.insertBefore(statusEl, panelContent.firstChild);
            }

            statusEl.style.borderLeftColor = status.color;
            statusEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                    <span style="font-size: 20px;">${status.icon}</span>
                    <span style="color: ${status.color}; font-weight: bold; font-size: 14px;">${status.status}</span>
                </div>
                <div style="color: var(--color-text-secondary); font-size: 12px;">${status.description}</div>
                ${status.population ? `<div style="color: var(--color-accent); font-size: 11px; margin-top: 5px;">üë• Population: ${status.population}</div>` : ''}
            `;

            const launchBtn = document.getElementById('launch-mission-btn');
            if (colonizationManager.isColonized(planetName)) {
                launchBtn.textContent = '‚úÖ Already Colonized';
                launchBtn.disabled = true;
                launchBtn.style.opacity = '0.5';
                launchBtn.style.cursor = 'not-allowed';
            } else {
                launchBtn.textContent = 'üöÄ Launch Mission';
                launchBtn.disabled = false;
                launchBtn.style.opacity = '1';
                launchBtn.style.cursor = 'pointer';
            }
        }

        // Launch sequence animation (card_403)
        async function playLaunchSequence(destination, onComplete) {
            const overlay = document.getElementById('launch-sequence-overlay');
            const countdownText = document.getElementById('countdown-text');

            const earth = renderer.scene.getObjectByName('Earth');
            if (earth) {
                renderer._animateCameraToPlanet(earth);
            }

            overlay.classList.add('active');

            const countdown = ['3', '2', '1', 'üöÄ LAUNCH!'];
            for (let i = 0; i < countdown.length; i++) {
                countdownText.textContent = countdown[i];
                countdownText.className = 'countdown-display';
                if (i === countdown.length - 1) {
                    countdownText.classList.add('launch');
                }
                await new Promise(resolve => setTimeout(resolve, i === countdown.length - 1 ? 1200 : 800));
            }

            overlay.classList.remove('active');
            if (onComplete) onComplete();
        }

        // Launch mission button
        document.getElementById('launch-mission-btn').addEventListener('click', async () => {
            if (!selectedPlanet) return;

            const destination = selectedPlanet.name;

            if (destination === 'Mars') {
                const canLaunch = missionManager.canLaunchMarsMission();
                if (!canLaunch.can) {
                    notificationManager.error('Mission Not Available', canLaunch.reason);
                    return;
                }
            }

            const costs = missionManager.getMissionCost(destination);

            if (!resourceManager.canAfford(costs)) {
                notificationManager.error('Mission Failed', 'Insufficient resources! Need: ' +
                    `$${costs.budget.toLocaleString()}, ${costs.science} science, ${costs.energy} energy, ${costs.materials} materials`);
                return;
            }

            await playLaunchSequence(destination, () => {
                const result = resourceManager.consume(costs);

                if (result.success) {
                    const travelTime = missionManager.getTravelTime('Earth', destination);
                    const mission = {
                        id: Date.now(),
                        name: destination === 'Mars' ? 'First Mars Expedition' : `Mission to ${destination}`,
                        origin: 'Earth',
                        destination: destination,
                        mission_type: destination === 'Mars' ? 'COLONIZATION' : 'EXPLORATION',
                        status: 'TRAVELING',
                        launch_year: currentGameYear,
                        arrival_year: currentGameYear + travelTime,
                        travel_time_years: travelTime,
                        progress: 0
                    };

                    missionManager.addMission(mission);
                    updateMissionsDisplay();

                    const eta = missionManager.formatTravelTime(travelTime);
                    notificationManager.success('Mission Launched! üöÄ',
                        `${mission.name} is underway! ETA: ${eta}`, 5000);

                    console.log(`üöÄ Mission to ${destination} launched. Arrival in ${eta}`);
                    tutorialManager.onEvent('mission-launch', destination);
                }
            });
        });

        await renderer.init();

        // Tutorial
        tutorialManager.init();
        setTimeout(() => {
            const started = tutorialManager.start();
            if (started) {
                console.log('üìö Tutorial started for new player');
            }
        }, 1000);

        tutorialManager.onComplete = () => {
            notificationManager.success('Tutorial Complete!',
                'You are ready to save humanity. Good luck, Commander!', 5000);
        };

        // Initialize trajectory renderer
        const planetsMap = new Map();
        for (const [name, planetData] of renderer.planets.entries()) {
            planetsMap.set(name, planetData.group);
        }

        trajectoryRenderer = new MissionTrajectoryRenderer(renderer.scene, planetsMap);

        uiController.onToggleTrajectories = () => {
            return trajectoryRenderer.toggleVisibility();
        };

        uiController.onMissionClick = (missionId) => {
            trajectoryRenderer.focusOnMission(missionId, renderer.camera, renderer.controls);
        };

        // Initialize building manager
        await buildingManager.init();
        buildingManager.onBuildingComplete = (building) => {
            notificationManager.success('Building Complete!', `${building.name} on ${building.planet} is now operational!`, 5000);
            updateBuildingsPanel();
        };

        // Initialize time manager
        timeManager.init(2100, 2100);

        // Initialize colonization manager
        colonizationManager.init();
        colonizationManager.onColonizationChange((data) => {
            if (selectedPlanet) {
                updateColonizationStatus(selectedPlanet);
            }
        });

        // Initialize research panel (card_709)
        researchPanel.init(1);
        researchPanel.onResearchStart = (result) => {
            if (result.error) {
                notificationManager.error('Research Failed', result.error);
            } else {
                notificationManager.success('Research Started! üî¨', result.message, 5000);
                updateResourcesHUD();
            }
        };

        // Initialize economy panel (card_711)
        economyPanel.init(resourceManager, buildingManager);

        // Load nation data
        const urlParams = new URLSearchParams(window.location.search);
        const selectedNationCode = urlParams.get('nation') || sessionStorage.getItem('selectedNation') || 'USA';
        let selectedNation = null;

        async function loadNationData(nationCode) {
            try {
                const response = await fetch(`php/api/nations.php?code=${nationCode}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const nation = result.data;
                    resourceManager.initializeResources({
                        budget: nation.starting_budget || 1000000,
                        science: nation.starting_science || 10000,
                        population: nation.starting_population || 500000000,
                        budgetMultiplier: nation.budget_multiplier || 1.0,
                        scienceMultiplier: nation.science_multiplier || 1.0,
                        populationGrowthRate: nation.population_growth_rate || 0.02
                    });

                    selectedNation = nation;
                    notificationManager.info('Nation Selected',
                        `Playing as ${nation.name}. Budget +${((nation.budget_multiplier - 1) * 100).toFixed(0)}%, Science +${((nation.science_multiplier - 1) * 100).toFixed(0)}%`,
                        5000);
                    return nation;
                } else {
                    throw new Error('Nation not found');
                }
            } catch (error) {
                console.warn('Failed to load nation, using defaults:', error);
                resourceManager.initializeResources({
                    budget: 1000000,
                    science: 10000,
                    population: 500000000
                });
                return null;
            }
        }

        loadNationData(selectedNationCode);

        // Save manager
        saveManager.init(1);
        saveManager.loadGame().then(gameState => {
            if (gameState && gameState.session) {
                saveManager.applyGameState(gameState, timeManager, resourceManager, missionManager);
            }
        }).catch(err => {
            console.log('üÜï Starting new game (load error):', err.message);
        });

        saveManager.startAutoSave();
        saveManager.onSave((data) => {
            console.log('üíæ Game saved at', data.saved_at);
        });

        // Game time
        const startYear = 2100;
        const startTime = performance.now();
        const yearEl = document.getElementById('game-year');
        const dateEl = document.getElementById('game-date');
        const resourcesList = document.getElementById('resources-list');
        const SECONDS_PER_GAME_YEAR = 86400;

        const MONTHS = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
        const DAYS_IN_MONTH = [31,28,31,30,31,30,31,31,30,31,30,31];

        function yearFractionToDate(fraction) {
            const totalHours = fraction * 365 * 24;
            let dayOfYear = Math.floor(totalHours / 24);
            const hour = Math.floor(totalHours % 24);
            let month = 0;
            let tempDay = dayOfYear;
            while (month < 11 && tempDay >= DAYS_IN_MONTH[month]) {
                tempDay -= DAYS_IN_MONTH[month];
                month++;
            }
            return `(${MONTHS[month]}-${String(dayOfYear + 1).padStart(2, '0')} ${String(hour).padStart(2, '0')}:00)`;
        }

        // Update resources HUD
        function updateResourcesHUD() {
            const formatted = resourceManager.getAllFormatted();
            const mainResources = ['budget', 'science', 'population', 'energy'];

            resourcesList.innerHTML = mainResources.map(resource => {
                const data = formatted[resource];
                if (!data) return '';

                const production = resourceManager.getProduction(resource);
                const rateClass = production > 0 ? 'positive' : production < 0 ? 'negative' : '';
                const rateText = production !== 0 ? `+${production.toFixed(0)}/year` : '';

                return `
                    <div class="resource-item">
                        <div class="resource-name">
                            <span class="resource-icon">${data.icon}</span>
                            <span>${data.name}</span>
                        </div>
                        <div class="resource-value">
                            <span class="resource-amount">${data.value}</span>
                            ${rateText ? `<span class="resource-rate ${rateClass}">${rateText}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Resource change animation
        function showResourceChange(resource, change) {
            const resourceDisplay = document.getElementById('resources-list');
            if (!resourceDisplay) return;
            const rect = resourceDisplay.getBoundingClientRect();

            const changeEl = document.createElement('div');
            changeEl.className = `resource-change ${change > 0 ? 'positive' : 'negative'}`;
            changeEl.textContent = `${change > 0 ? '+' : ''}${Math.floor(change)}`;
            changeEl.style.left = `${rect.right - 60}px`;
            changeEl.style.top = `${rect.top + 40}px`;

            document.body.appendChild(changeEl);
            setTimeout(() => changeEl.remove(), 1500);
        }

        resourceManager.onChange((changes) => {
            for (const [resource, data] of Object.entries(changes)) {
                if (Math.abs(data.change) > 0) {
                    showResourceChange(resource, data.change);
                }
            }
            updateResourcesHUD();
        });

        updateResourcesHUD();

        // Missions display
        function updateMissionsDisplay() {
            const missionsListEl = document.getElementById('missions-list');
            const activeMissions = missionManager.getActiveMissions();

            if (activeMissions.length === 0) {
                missionsListEl.innerHTML = '<div style="color: var(--color-text-faint); font-size: var(--font-size-base);">No active missions</div>';
                return;
            }

            missionsListEl.innerHTML = activeMissions.map(m => {
                const progress = (m.progress * 100).toFixed(0);
                const yearsRemaining = m.arrival_year - currentGameYear;
                const etaRealTime = missionManager.formatTravelTime(yearsRemaining);
                const gameYearsRemaining = yearsRemaining.toFixed(1);

                let badge = '';
                let badgeColor = 'var(--color-accent)';
                if (m.mission_type === 'COLONIZATION') {
                    badge = 'üèóÔ∏è';
                    badgeColor = 'var(--color-warning)';
                } else {
                    badge = 'üîç';
                    badgeColor = 'var(--color-success)';
                }

                let rewardsHtml = '';
                if (m.mission_type === 'COLONIZATION' && m.destination === 'Mars') {
                    rewardsHtml = `
                        <div style="font-size: var(--font-size-xs); color: var(--color-accent); margin-top: 3px; padding-top: 3px; border-top: 1px solid var(--color-accent-subtle);">
                            Expected rewards: üî¨ +5000, üë• +50 colonists
                        </div>
                    `;
                }

                return `
                    <div class="mission-item" data-mission-id="${m.id}" title="Click to focus on mission trajectory">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 16px;">${badge}</span>
                                <span style="font-size: var(--font-size-base); color: var(--color-text-primary); font-weight: 500;">${m.name || (m.origin + ' ‚Üí ' + m.destination)}</span>
                            </div>
                            <span style="color: ${badgeColor}; font-size: var(--font-size-xs); font-weight: bold; background: var(--color-accent-subtle); padding: 2px 6px; border-radius: 3px;">
                                ${m.mission_type || 'EXPLORATION'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-text-dim); margin-bottom: 4px;">
                            <span>‚è±Ô∏è ETA: ${etaRealTime} (${gameYearsRemaining}y)</span>
                            <span style="color: var(--color-accent);">${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%; box-shadow: 0 0 8px var(--color-accent-glow);"></div>
                        </div>
                        ${rewardsHtml}
                    </div>
                `;
            }).join('');

            if (trajectoryRenderer) {
                trajectoryRenderer.update(activeMissions);
            }

            setTimeout(() => uiController.setupMissionClickHandlers(), 0);
        }

        // Buildings panel management
        function updateBuildingsPanel() {
            const availableList = document.getElementById('buildings-available-list');
            const buildings = buildingManager.getAvailableBuildings();

            availableList.innerHTML = buildings.map(building => {
                const icon = buildingManager.getBuildingIcon(building.building_code);
                const count = buildingManager.getBuildingCount(building.building_code, 'Earth');

                return `
                    <div class="building-card">
                        <div class="building-name">${icon} ${building.name} (${count}/${building.max_per_planet})</div>
                        <div class="building-desc">${building.description}</div>
                        <div class="building-costs">
                            <span class="cost-item">üí∞ $${(building.budget_cost / 1000).toFixed(0)}K</span>
                            <span class="cost-item">üî© ${building.materials_cost}</span>
                            <span class="cost-item">‚ö° ${building.energy_cost}</span>
                            <span class="cost-item">‚è±Ô∏è ${building.construction_time_years}y</span>
                        </div>
                        <button class="build-btn" data-building-code="${building.building_code}">
                            üèóÔ∏è Build
                        </button>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.build-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleBuildClick(btn.dataset.buildingCode);
                });
            });

            updateConstructionList();
        }

        function updateConstructionList() {
            const inConstructionEl = document.getElementById('buildings-in-construction');
            const inConstruction = buildingManager.getBuildingsInConstruction();

            if (inConstruction.length === 0) {
                inConstructionEl.innerHTML = '<div style="color: var(--color-text-faint); font-size: var(--font-size-base);">No buildings in construction</div>';
            } else {
                inConstructionEl.innerHTML = inConstruction.map(b => {
                    const icon = buildingManager.getBuildingIcon(b.building_code);
                    const progress = (b.progress * 100).toFixed(0);
                    const yearsLeft = (b.construction_completion_year - currentGameYear).toFixed(1);

                    return `
                        <div class="building-card">
                            <div class="building-name">${icon} ${b.name}</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-muted); margin-bottom: 5px;">
                                ‚è±Ô∏è ${yearsLeft} years remaining
                            </div>
                            <div class="building-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-faint); margin-top: 2px;">${progress}%</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const completedEl = document.getElementById('buildings-completed');
            const completed = buildingManager.getPlanetBuildings('Earth').filter(b => b.status === 'COMPLETED');

            if (completed.length === 0) {
                completedEl.innerHTML = '<div style="color: var(--color-text-faint); font-size: var(--font-size-base);">No buildings completed</div>';
            } else {
                completedEl.innerHTML = completed.map(b => {
                    const icon = buildingManager.getBuildingIcon(b.building_code);
                    return `
                        <div style="padding: var(--space-sm); background: var(--color-accent-subtle); border-radius: var(--border-radius-md); margin-bottom: 5px;">
                            <span style="font-size: var(--font-size-base);">${icon} ${b.name}</span>
                        </div>
                    `;
                }).join('');
            }
        }

        function handleBuildClick(buildingCode) {
            const result = buildingManager.startConstruction(buildingCode, 'Earth');

            if (result.success) {
                notificationManager.success('Construction Started', `Building ${result.building.name} on Earth`, 3000);
                updateBuildingsPanel();
                updateResourcesHUD();
            } else {
                notificationManager.error('Cannot Build', result.error, 3000);
            }
        }

        // Buildings tab switching
        document.querySelectorAll('.buildings-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabId = e.target.id;
                document.querySelectorAll('.buildings-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');

                if (tabId === 'buildings-tab-build') {
                    document.getElementById('buildings-build-content').style.display = 'block';
                    document.getElementById('buildings-list-content').style.display = 'none';
                } else {
                    document.getElementById('buildings-build-content').style.display = 'none';
                    document.getElementById('buildings-list-content').style.display = 'block';
                }
            });
        });

        updateBuildingsPanel();

        // Mission completion
        missionManager.onMissionComplete((missionResult) => {
            const mission = missionResult.mission;
            const colonizationResult = colonizationManager.handleMissionCompletion(mission, currentGameYear);

            if (missionResult.rewards) {
                const rewards = missionResult.rewards;
                if (rewards.science) {
                    resourceManager.add({ science: rewards.science });
                }
                if (rewards.population) {
                    resourceManager.add({ population: rewards.population });
                }
                updateResourcesHUD();

                if (colonizationResult.colonized) {
                    notificationManager.success(`üéâ ${mission.destination} Colony Established!`,
                        `First human settlement on ${mission.destination}! +${rewards.science} science, +${rewards.population} colonists.`, 10000);
                } else {
                    notificationManager.success(`üîç ${mission.destination} Explored!`,
                        `Mission to ${mission.destination} completed! +${rewards.science} science.`, 8000);
                }
            } else {
                if (colonizationResult.colonized) {
                    notificationManager.success(`üèõÔ∏è ${mission.destination} Colonized!`,
                        `${mission.destination} has been successfully colonized!`, 8000);
                } else {
                    notificationManager.success('Mission Complete! üéâ',
                        `Mission to ${mission.destination} has arrived successfully!`, 8000);
                }
            }

            updateMissionsDisplay();
        });

        let currentGameYear = 2100;
        let lastFrameTime = performance.now();
        let lastMissionUpdate = 0;

        function animate() {
            requestAnimationFrame(animate);

            const now = performance.now();
            const deltaTime = now - lastFrameTime;
            lastFrameTime = now;

            const elapsedSeconds = (now - startTime) / 1000;
            const gameYear = startYear + elapsedSeconds / SECONDS_PER_GAME_YEAR;
            currentGameYear = gameYear;
            renderer.setGameYear(gameYear);

            const yearInt = Math.floor(gameYear);
            const fraction = gameYear - yearInt;
            yearEl.textContent = yearInt;
            dateEl.textContent = yearFractionToDate(fraction);

            resourceManager.update(deltaTime);

            if (now - lastMissionUpdate > 1000) {
                missionManager.update(gameYear);
                updateMissionsDisplay();

                const completedBuildings = buildingManager.update(gameYear);
                if (completedBuildings.length > 0) {
                    buildingManager.applyProductionBonuses();
                }

                const buildingsPanel = document.getElementById('buildings-panel');
                if (buildingsPanel.style.display !== 'none') {
                    updateConstructionList();
                }

                // Update research progress
                researchPanel.updateProgress(gameYear);

                // Update economy panel periodically
                economyPanel.render();

                lastMissionUpdate = now;
            }

            renderer.render();
        }

        animate();
    </script>
</body>
</html>
